# Plan (Chinese)

## Prototype 0.1

### 功能概览
- 服务端将加密索引和配置文件作为文件存储在磁盘中（文件夹使用服务ID标识）， 当和客户端建立起连接后，再从中读取至内存中。
- 客户端将配置文件的Hash值作为服务ID (Service ID, sid)，
如果sid已存在，则服务器根据sid找到配置文件和数据库文件，读取至内存中，并根据配置初始化SSE程序；
否则，则需要客户端传输配置文件至服务端中，进行数据库的初始化操作。
- 该版本不支持文档本身的加解密，支持加密索引功能。所以配置文件目前也是写死的，
不用文件扫描功能来配置参数。
- 使用websockets进行客户端和服务端的通讯
- 对于单个服务（sid），服务器有以下几个状态：
  - `0`: 未创建/未配置（不保存任何信息）
  - `1`: 已配置但没有上传加密数据库（只保存配置文件）
  - `2`: 已完全配置状态（保存配置文件和数据库），可以进行搜索
  - `0`: 删除状态 --> 删除sid对应的目录，重新进入未配置状态
- 对于单个服务（sid），客户端有以下几个状态：(bit标记)
  - 第1个bit: 表示配置文件创建了没有
  - 第2个bit: 表示配置文件上传了没有
  - 第3个bit: 表示密钥创建了没有
  - 第4个bit: 表示数据库加密了没有
  - 第5个bit: 表示数据库上传了没有
- 配置文件应包含的字段：
  - `scheme`: 选用的方案
  - `salt`: 客户端选用的盐值, 用于区别相同配置的不同服务
  - 用户的配置信息
- 对于每个服务，服务器应该需要维护以下状态信息（服务全局状态）：
  - `status`: 当前服务状态
- 对于每个服务，客户端需要维护以下全局状态:
  - `status`: 当前服务状态
  - `key`: 密钥信息: 需要用口令加密


### websockets字段说明

- `sid`: `str`类型，服务ID,
- `type`: `str`类型，信息类型 --> 便于websockets路由
  - `init`: 首次连接，以开启服务。服务器进入服务状态。如果服务器发现`sid`不存在，则提醒客户端上传配置文件。
  - `upload_config`: 传输配置文件，需要有`config`字段传输配置文件信息(json格式)。 
  如果服务器发现`sid`已经存在，拒绝配置，说明该`sid`已经配置好了。
  否则，配置该服务，创建`sid`对应目录，然后写入到该目录内，并进入已配置但没有上传加密数据库状态；
  - `upload_db`: 传输加密数据库，需要有`db`字段传输配置文件信息(二进制形式)。
  如果服务器发现该`sid`已经存在数据库 or 未配置，拒绝接收。否则，写入加密数据库到该目录内，并进入已完全配置状态；
  - `search`: 搜索请求，需要有`token`字段传输关键字信息(二进制形式)。
  如果服务器发现该`sid`未完全配置，拒绝搜索。否则，进行搜索；
  - `result`: 搜索结果，需要有`result`字段传输结果(二进制形式)。
  - `delete`: 删除服务
  如果服务器发现`sid`不存在，则返回错误信息，否则，删除该服务
  - `error`: 错误信息，需要使用`msg`传输错误信息。

### 目前发现的问题

- 断开连接后, 数据库也断开了，应该需要维持一段时间（目前的方案也只能单点连接，如果多客户端场景会有并发的可能）
